<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lobbies</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
    <ul id="lobbyList"></ul>

    <br/>

    <a href="profile.html">Profile</a>
    <br/>
    <button type="button" onclick="logout()">Logout</button>

    <script>
        function refreshLobbyList(numLobbies) {
            var lobbyList = $('#lobbyList');
            lobbyList.empty();

            for(var i = 0; i < numLobbies; i++) {
                var item = '<li> <button onclick="joinLobby(' + i + ')"> Lobby' + i + '</button> </li>';
                lobbyList.append(item);
            }
        }

        function joinLobby(lobbyIndex) {
            // set lobbyIndex, userId, and equipped skills before joining
            localStorage.setItem('lobbyIndex', lobbyIndex);

            var username = localStorage.getItem('username');
            $.get(`services/user/user_id?username=${username}`)
            .done(function(data) {
                    localStorage.setItem('user_id', data);
                }
            )
            .done(function() {
                $.get(`services/user/skill_ids?username=${username}`)
                .done(function(data) {
                    localStorage.setItem('skill_ids', data);
                    location.href = 'lobby.html';
                });
            });


        }

        function logout() {
            var username = localStorage.getItem('username');

            function success(data, status, jqhxr) {
                location.href = 'login.html';
            };

            function error(jqXHR, textStatus, errorThrown) {
                console.log('logout failed');
            };

            $.ajax({
                type: 'POST',
                url: 'services/user/logout',
                data: 'username=' + username,
                success: success,
                error: error,
                dataType: 'text'
            });
        }

        $(document).ready(function() {
            $.get('services/lobbylist/num_lobbies',
                function (data) {
                    refreshLobbyList(parseInt(data));
                }
            );

        });
    </script>
</body>
</html>